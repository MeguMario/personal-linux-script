#!/bin/bash

kernel_check() {
	REPO_DIR="${HOME}/cachyos_repo/cachyos-repo/pacman.conf"
	
	# Sync database
	paru -Sy --config $REPO_DIR --noconfirm > /dev/null 2>&1;
	
	# Check for the latest tag
	REMOTE_VER=$(pacman -Ss linux-cachyos --config $REPO_DIR | grep -m 1 -Eo '[0-9]+.[0-9]+.[0-9]+-[0-9]')
	CURRENT_VER=$(pacman -Q linux-cachyos | sed -n -e 's/^.*linux-cachyos //p')

	if [[ "$CURRENT_VER" != "$REMOTE_VER" ]]; then
	    # echo "linux-cachyos version ${REMOTE_VER} found, updating"

	    echo Updating Kernel
	    paru -S linux-cachyos linux-cachyos-headers --config $REPO_DIR --noconfirm 

		reboot_prompt
	    # echo "linux-cachyos version ${REMOTE_VER} is updated"
	else
	    echo "linux-cachyos version ${CURRENT_VER} is up to date"
	fi
}

gnome-shell_check() {
	PKGBUILD_DIR="/tmp"
	CLONE_URL="https://gitlab.archlinux.org/archlinux/packaging/packages/gnome-shell"
	
	# Sync database
	paru -Sy --noconfirm > /dev/null 2>&1;
	
	# Check for the latest tag
	REMOTE_VER=$(pacman -Ss gnome-shell | grep -m 1 -Eo '[0-9]+.[0-9]+-[0-9]')
	CURRENT_VER=$(pacman -Q gnome-shell | sed -n -e 's/^.*gnome-shell 1://p')
	
	if [[ "$CURRENT_VER" != "$REMOTE_VER" ]]; then
	    # echo "GNOME Shell version ${REMOTE_VER} found, updating"
	    # cd $HOME/$PKGBUILD_DIR
	    cd $PKGBUILD_DIR

	    # Remove current working dir if found
	    if [ -d "gnome-shell" ]; then
				rm -rf gnome-shell
				git clone $CLONE_URL
				cd gnome-shell
			else
				git clone $CLONE_URL
				cd gnome-shell
	    fi

	    echo Patching PKGBUILD
	    sed -i 's@"git+https://gitlab.gnome.org/GNOME/libgnome-volume-control.git#commit=5f9768a2eac29c1ed56f1fbb449a77a3523683b6"@"https://github.com/user-attachments/files/22458817/Shell_BlurEffect__rounded_corners_mask.patch" "git+https://gitlab.gnome.org/GNOME/libgnome-volume-control.git#commit=5f9768a2eac29c1ed56f1fbb449a77a3523683b6"@g' PKGBUILD
	    sed -i  "s@'e31ae379039dfc345e8032f7b9803a59ded075fc52457ba1553276d3031e7025d9304a7f2167a01be2d54c5e121bae00a2824a9c5ccbf926865d0b24520bb053'@'3bcb9a4271376dba7b11a0d59d5fb1db70b395188c0584c473d652971bfbcad2bc6dfa5202ff90ba6fccea58f5d87829d87b449d9370e310fb8c6580778efe81' 'e31ae379039dfc345e8032f7b9803a59ded075fc52457ba1553276d3031e7025d9304a7f2167a01be2d54c5e121bae00a2824a9c5ccbf926865d0b24520bb053'@g" PKGBUILD
		sed -i  "s@cd "'$pkgbase'"@cd "'$pkgbase'"; patch -Np1 -i ../Shell_BlurEffect__rounded_corners_mask.patch@g" PKGBUILD

	    echo Building GNOME Shell
	    makepkg -si --noconfirm

		reboot_prompt
	    # echo "GNOME Shell version ${CURRENT_VER} is updated"
	else
	    echo "GNOME Shell version ${CURRENT_VER} is up to date"
	fi
}

update_all(){
	# Update linux-cachyos
	# kernel_check;

	# Update Waydroid Image
	# android_image_check;
	
	# Update SteamOS Manager
	# steamos_manager_check;

	# Update patched Gnome Shell
	gnome-shell_check;

	# Global update (AUR included)
	until paru -Syu --noconfirm --overwrite "*" --nodeps; do sleep 1; done;
	# arch-update

	# Rebuild qadwaitadecorations
	until paru -S qadwaitadecorations-qt6-git qadwaitadecorations-qt5-git --noconfirm; do sleep 1; done;

	# Update gamescope
	# paru -S gamescope-git gamescope-session-steam-git gamescope-session-git
	# paru -S aur/gamescope-git aur/gamescope-session-git aur/gamescope-session-steam-git --noconfirm
	# paru -S aur/gamescope-git aur/gamescope-session-git --noconfirm

	# Update flatpak apps
	flatpak update --noninteractive;
	flatpak update --user --noninteractive;

	# Cleanup
	paru -Scc --noconfirm;
	paru --clean --noconfirm;
	
	reboot_prompt
}

reboot_prompt(){
	# Choices
	echo "Do you want to reboot?"
	select yn in "Yes" "No"; do
	    case $yn in
				Yes ) sudo reboot; break;;
				No ) exit;;
	    esac
	done
}

# More safety, by turning some bugs into errors.
set -o errexit -o pipefail -o noclobber -o nounset

# ignore errexit with `&& true`
getopt --test > /dev/null && true
if [[ $? -ne 4 ]]; then
    echo 'I’m sorry, `getopt --test` failed in this environment.'
    exit 1
fi

LONGOPTS=all,kernel,gnome-shell
OPTIONS=Akg

# -temporarily store output to be able to check for errors
# -activate quoting/enhanced mode (e.g. by writing out “--options”)
# -pass arguments only via   -- "$@"   to separate them correctly
# -if getopt fails, it complains itself to stderr
PARSED=$(getopt --options=$OPTIONS --longoptions=$LONGOPTS --name "$0" -- "$@") || exit 2
# read getopt’s output this way to handle the quoting right:
eval set -- "$PARSED"

k=n A=n g=n
# now enjoy the options in order and nicely split until we see --
while true; do
    case "$1" in
        -A|--all)
            A=y
            update_all
            shift
            break
            ;;
				-k|--kernel)
			  			k=y
            kernel_check
            shift
            break
            ;;
        -g|--gnome-shell)
            g=y
            gnome-shell_check
            shift
            break
            ;;
        --)
            shift
            break
            ;;
        *)
            echo "Programming error"
            exit 3
            ;;
    esac
done

# handle non-option arguments
if [[ $# -ne 1 ]]; then
    echo "$0: A single input file is required."
    exit 4
fi

# echo "all: $A, kernel: $k, gnome-shell: $g"